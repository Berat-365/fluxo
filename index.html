<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxo Page</title>
    <link rel="icon" type="image/icon" href="ico/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Microphone icon turns red when active */
        #voiceIcon.active {
            filter: invert(29%) sepia(99%) saturate(7482%) hue-rotate(359deg) brightness(97%) contrast(119%);
        }
    </style>
</head>
<body>
    <video id="backgroundVideo" autoplay loop muted playsinline preload="auto" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; will-change: transform;">
        <source src="" type="video/mp4">
    </video>
    <iframe id="backgroundYouTube" frameborder="0" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; object-fit: cover; transform: scale(1.1); will-change: transform;" allow="autoplay; encrypted-media"></iframe>
    <div class="weather-widget" id="weatherWidget" onclick="window.open('https://wttr.in', '_blank')">Yükleniyor...</div>
    <div class="info-bar" id="infoBar">
        Fluxo 3.8,2 | Vanilla | <span id="languageDisplay">Türkçe</span>
        <span id="accountInfo" style="margin-left:0px;"></span>
    </div>
    <div class="url-sidebar" id="urlSidebar"></div>
<button id="menuButton">
    <img id="menuIcon" src="ico/menu.png" alt="Menü">
</button>
<div id="menuPanel">
    <div class="tab-menu">
        <button class="tab-button active" data-tab="settings" data-lang-key="settings">Ayarlar</button>
        <button class="tab-button" data-tab="history" data-lang-key="history">Geçmiş</button>
    </div>
    <div id="settingsContent" class="tab-content active">
        <button id="applySettingsBtn" class="accent" data-lang-key="apply">Uygula</button>
        <button id="clearHistoryBtn" class="accent" data-lang-key="clearHistory">Geçmişi Temizle</button>
        <h3 data-lang-key="personalization">Kişiselleştirme</h3>
        <label for="bgUrlInput" data-lang-key="bgUrl">Arka Plan URL (Resim, Video veya YouTube):</label>
        <input type="text" id="bgUrlInput" placeholder="https://... (jpg, png, mp4, webm, ogg, youtube.com)">
        <div id="recentBgList" style="margin-top: 5px;"></div>
        <label for="fontSelect" data-lang-key="font">Yazı Tipi:</label>
        <select id="fontSelect">
            <option value="'Segoe UI', sans-serif">Segoe UI</option>
            <option value="'Arial', sans-serif">Arial</option>
            <option value="'Courier New', monospace">Courier New</option>
            <option value="'Georgia', serif">Georgia</option>
            <option value="'Roboto', sans-serif">Roboto</option>
            <option value="'Open Sans', sans-serif">Open Sans</option>
            <option value="'Lato', sans-serif">Lato</option>
            <option value="'Montserrat', sans-serif">Montserrat</option>
            <option value="'Inter', sans-serif">Inter</option> 
        </select>
        <label for="themeSelect" data-lang-key="theme">Renk Teması:</label>
        <select id="themeSelect">
            <option value="dark" data-lang-key="dark">Koyu</option>
            <option value="light" data-lang-key="light">Açık</option>
        </select>
        <label for="accentColor" data-lang-key="accentColor">Vurgu Rengi:</label>
        <div id="colorPalette" class="flex flex-wrap gap-2 mt-2">
            <div class="color-option" style="background-color: #00bcd4;" onclick="selectColor('#00bcd4')"></div>
            <div class="color-option" style="background-color: #ff5722;" onclick="selectColor('#ff5722')"></div>
            <div class="color-option" style="background-color: #4caf50;" onclick="selectColor('#4caf50')"></div>
            <div class="color-option" style="background-color: #9c27b0;" onclick="selectColor('#9c27b0')"></div>
            <div class="color-option" style="background-color: #ffeb3b;" onclick="selectColor('#ffeb3b')"></div>
        </div>
        <input type="color" id="accentColor" value="#00bcd4">
        <label for="languageSelect" data-lang-key="language">Dil:</label>
        <select id="languageSelect">
            <option value="tr" data-lang-key="turkish">Türkçe</option>
            <option value="en" data-lang-key="english">English</option>
            <option value="es" data-lang-key="spanish">Español</option>
            <option value="ru" data-lang-key="russian">Русский</option>
            <option value="jp" data-lang-key="japanese">日本語</option>
            <option value="zh" data-lang-key="chinese">中文</option>
            <option value="ko" data-lang-key="korean">한국어</option>
            <option value="de" data-lang-key="german">Deutsch</option>
            <option value="fr" data-lang-key="french">Français</option>
            <option value="ar" data-lang-key="arabic">العربية</option>
            <option value="az" data-lang-key="azerbaijani">Azərbaycan dili</option>
            <option value="tk" data-lang-key="turkmen">Türkmençe</option>
            <option value="kk" data-lang-key="kazakh">Қазақша</option>
            <option value="ky" data-lang-key="kyrgyz">Кыргызча</option>
            <option value="uz" data-lang-key="uzbek">O'zbekcha</option>
            <option value="tt" data-lang-key="tatar">Татарча</option>
            <option value="ba" data-lang-key="bashkir">Башкортса</option>
            <option value="ug" data-lang-key="uyghur">ئۇيغۇرچە</option>
            <option value="sah" data-lang-key="yakut">Саха тыла</option>
            <option value="cv" data-lang-key="chuvash">Чӑваш чӗлхи</option>
            <option value="gag" data-lang-key="gagavuz">Gagavuzca</option>
        </select>
        <label for="logoDisplaySelect" data-lang-key="logoDisplay">Logo Görüntüleme:</label>
        <select id="logoDisplaySelect">
            <option value="logo" data-lang-key="logoOnly">Sadece Logo</option>
            <option value="logo-name" data-lang-key="logoAndName">Logo ve İsim</option>
            <option value="none" data-lang-key="none">Hiçbiri</option>
        </select>
        <h3 data-lang-key="system">Sistem</h3>
        <div class="flex flex-col mb-2">
            <label for="weatherAPI" data-lang-key="weatherAPI" class="text-sm mb-1">Hava Durumu API:</label>
            <select id="weatherAPI" class="border rounded px-2 py-1 text-sm w-full max-w-xs">
                <option value="openweathermap" data-lang-key="openweathermap">OpenWeatherMap</option>
                <option value="weatherapi" data-lang-key="weatherapi">WeatherAPI</option>
                <option value="openmeteo" data-lang-key="openmeteo">Open-Meteo</option>
                <option value="visualcrossing" data-lang-key="visualcrossing">Visual Crossing</option>
                <option value="wttrin" data-lang-key="wttrin">wttr.in</option>
            </select>
        </div>
        <div class="api-key-input" id="openWeatherMapKeyInput">
            <label for="openWeatherMapApiKey" data-lang-key="openWeatherMapApiKey">OpenWeatherMap API Anahtarı:</label>
            <input type="text" id="openWeatherMapApiKey" placeholder="OpenWeatherMap anahtarınızı girin" class="border rounded px-2 py-1 text-sm w-full max-w-xs">
        </div>
        <div class="api-key-input" id="weatherApiKeyInput">
            <label for="weatherApiKey" data-lang-key="weatherApiKey">WeatherAPI Anahtarı:</label>
            <input type="text" id="weatherApiKey" placeholder="WeatherAPI anahtarınızı girin" class="border rounded px-2 py-1 text-sm w-full max-w-xs">
        </div>
        <div class="api-key-input" id="visualCrossingKeyInput">
            <label for="visualCrossingApiKey" data-lang-key="visualCrossingApiKey">Visual Crossing API Anahtarı:</label>
            <input type="text" id="visualCrossingApiKey" placeholder="Visual Crossing anahtarınızı girin" class="border rounded px-2 py-1 text-sm w-full max-w-xs">
        </div>
        <label for="searchEngineSelect" data-lang-key="searchEngine">Arama Motoru:</label>
        <select id="searchEngineSelect">
            <option value="google">Google</option>
            <option value="bing">Bing</option>
            <option value="duckduckgo">DuckDuckGo</option>
            <option value="yandex">Yandex</option>
            <option value="yahoo">Yahoo</option>
        </select>
        <div id="searchEnginePreview" style="margin-top: 10px; text-align: center;">
            <img src="" alt="Arama Motoru Önizlemesi" style="max-height: 40px; display: none;" id="engineLogo">
        </div>
        <label for="showFavorites" data-lang-key="showFavorites">Favorileri Göster:</label>
        <select id="showFavorites">
            <option value="true" data-lang-key="yes">Evet</option>
            <option value="false" data-lang-key="no">Hayır</option>
        </select>
        <label for="maxFavorites" data-lang-key="maxFavorites">Maksimum Favori Sayısı:</label>
        <select id="maxFavorites">
            <option value="5">5</option>
            <option value="10">10</option>
        </select>
        <label for="showSuggestions" data-lang-key="showSuggestions">Arama Önerilerini Göster:</label>
        <select id="showSuggestions">
            <option value="true" data-lang-key="yes">Evet</option>
            <option value="false" data-lang-key="no">Hayır</option>
        </select>
        <label for="showWeather" data-lang-key="showWeather">Hava Durumunu Göster:</label>
        <select id="showWeather">
            <option value="true" data-lang-key="yes">Evet</option>
            <option value="false" data-lang-key="no">Hayır</option>
        </select>
        <label for="weatherLocation" data-lang-key="weatherLocation">Hava Durumu Konumu:</label>
        <input type="text" id="weatherLocation" placeholder="Şehir ismi">
        <label for="weatherUpdateInterval" data-lang-key="weatherUpdateInterval">Hava Durumu Güncelleme Sıklığı:</label>
        <select id="weatherUpdateInterval">
            <option value="5" data-lang-key="every5Min">Her 5 Dakika</option>
            <option value="10" data-lang-key="every10Min">Her 10 Dakika</option>
            <option value="30" data-lang-key="every30Min">Her 30 Dakika</option>
            <option value="0" data-lang-key="manual">Manuel</option>
        </select>
        <label for="linkBehavior" data-lang-key="linkBehavior">Link Davranışı:</label>
        <select id="linkBehavior">
            <option value="newTab" data-lang-key="newTab">Yeni Sekmede Aç</option>
            <option value="closeCurrent" data-lang-key="closeCurrent">Bu Sayfayı Kapat</option>
        </select>
        <label for="showInfoBar" data-lang-key="showInfoBar">Bilgi Barını Göster:</label>
        <select id="showInfoBar">
            <option value="true" data-lang-key="yes">Evet</option>
            <option value="false" data-lang-key="no">Hayır</option>
        </select>
        <h3 data-lang-key="aiSettings">Yapay Zeka Ayarları</h3>
        <label for="aiProviderSelect" data-lang-key="aiProvider">Yapay Zeka Sağlayıcısı:</label>
        <select id="aiProviderSelect">
            <option value="grok" data-lang-key="grok">Grok (xAI)</option>
            <option value="chatgpt" data-lang-key="chatgpt">ChatGPT (OpenAI)</option>
            <option value="claude" data-lang-key="claude">Claude (Anthropic)</option>
            <option value="custom" data-lang-key="custom">Özel</option>
        </select>
        <div class="flex items-center gap-2">
            <label for="showAISearch" data-lang-key="showAISearch" class="text-sm">AI Ara Butonunu Göster</label>
            <input type="checkbox" id="showAISearch" class="w-4 h-4">
        </div>
        <label for="customAiUrl" data-lang-key="customAiUrl">Özel AI Sitesi URL'si (isteğe bağlı):</label>
        <input type="text" id="customAiUrl" placeholder="https://ai.example.com">
        <h3 data-lang-key="shortcuts">Klavye Kısayolları</h3>
        <label for="searchShortcutInput" data-lang-key="searchShortcut">Arama Çubuğu:</label>
        <input type="text" id="searchShortcutInput" placeholder="Ör: Ctrl + /" value="Ctrl + /">
        <label for="favoriteShortcutInput" data-lang-key="favoriteShortcut">Favori Ekle:</label>
        <input type="text" id="favoriteShortcutInput" placeholder="Ör: Ctrl + Shift + F" value="Ctrl + Shift + F">
        <label for="settingsShortcutInput" data-lang-key="settingsShortcut">Ayarlar Paneli:</label>
        <input type="text" id="settingsShortcutInput" placeholder="Ör: Ctrl + Shift + X" value="Ctrl + Shift + X">
        <label for="historyShortcutInput" data-lang-key="historyShortcut">Geçmiş Paneli:</label>
        <input type="text" id="historyShortcutInput" placeholder="Ör: Ctrl + Shift + H" value="Ctrl + Shift + H">
        <label for="imagesShortcutInput" data-lang-key="imagesShortcut">Görseller Araması:</label>
        <input type="text" id="imagesShortcutInput" placeholder="Ör: Ctrl + i" value="Ctrl + i">
        <label for="shoppingShortcutInput" data-lang-key="shoppingShortcut">Alışveriş Araması:</label>
        <input type="text" id="shoppingShortcutInput" placeholder="Ör: Ctrl + S" value="Ctrl + S">
        <label for="newsShortcutInput" data-lang-key="newsShortcut">Haberler Araması:</label>
        <input type="text" id="newsShortcutInput" placeholder="Ör: Ctrl + N" value="Ctrl + N">
        <label for="accountShortcutInput" data-lang-key="accountShortcut">Hesap Paneli:</label>
        <input type="text" id="accountShortcutInput" placeholder="Ör: Ctrl + Shift + A" value="Ctrl + Shift + A">
        <label for="aiShortcutInput" data-lang-key="aiShortcut">Yapay Zeka Araması:</label>
        <input type="text" id="aiShortcutInput" placeholder="Ör: Ctrl + Shift + I" value="Ctrl + Shift + I">
    </div>
    <div id="historyContent" class="tab-content">
        <h3 data-lang-key="searchHistory">Arama Geçmişi</h3>
        <div id="historyList"></div>
    </div>
</div>
<button id="accountButton" title="Hesap">
        <img id="accountIcon" src="ico/account.png" alt="Hesap">
    </button>
<div id="addFavoriteModal">
        <span class="close" onclick="document.getElementById('addFavoriteModal').style.display='none'">×</span>
        <label for="modalName" data-lang-key="favoriteName">İsim:</label>
        <input type="text" id="modalName" placeholder="Favori ismi">
        <label for="modalUrl" data-lang-key="favoriteUrl">URL:</label>
        <input type="text" id="modalUrl" placeholder="https://...">
        <button id="addFavoriteModalBtn" class="accent" data-lang-key="add">Ekle</button>
    </div>
    <div id="voiceSearchModal" class="modal">
        <div id="voiceTranscript" contenteditable="true" class="transcript" data-placeholder="Söyledikleriniz burada görünecek..."></div>
        <button id="confirmVoiceBtn" class="accent" data-lang-key="confirm">Tamam</button>
        <button id="cancelVoiceBtn" class="accent" data-lang-key="cancel">İptal</button>
    </div>
    <div class="container">
        <div class="logo" id="logo">
            <a href="#" onclick="window.location.reload()">
                <img src="ico/logo.png" alt="Fluxo Logo" id="logoImg">
                <span class="logo-name" id="logoName">Fluxo</span>
            </a>
        </div>
        <div class="search-bar" id="searchBar">
            <span class="icon-left"><img id="searchIcon" src="ico/search.png" alt="Arama"></span>
            <input type="text" id="searchInput" placeholder="Arama yap..." autofocus>
            <span class="icon-right" id="voiceSearchBtn"><img id="voiceIcon" src="ico/mic.png" alt="Sesli Arama"></span>
            <ul id="suggestions" role="listbox" aria-label="Arama önerileri"></ul>
        </div>
<div class="buttons">
    <button id="searchWebBtn" class="accent" data-lang-key="search">Ara</button>
    <button id="searchImagesBtn" class="accent" data-lang-key="images">Görseller</button>
    <button id="searchShoppingBtn" class="accent" data-lang-key="shopping">Alışveriş</button>
    <button id="searchNewsBtn" class="accent" data-lang-key="news">Haberler</button>
    <button id="searchAIBtn" class="accent" data-lang-key="aiSearch">AI Arama</button>
</div>
        <div class="favorites" id="favorites">
            <div id="addFavoriteBtn" class="favorite-item accent" data-lang-key="addFavorite">+ Favori Ekle</div>
        </div>
    </div>
    <div id="accountModal">
        <div id="accountModalInner">
            <span class="close" onclick="closeAccountPanel()">×</span>
            <h3 id="accountModalTitle" data-lang-key="account">Hesap</h3>
            <div id="accountForm">
                <input type="text" id="accountUsername" placeholder="Kullanıcı adı" autocomplete="username">
                <input type="password" id="accountPassword" placeholder="Şifre" autocomplete="current-password">
                <div>
                    <button id="accountLoginBtn" class="accent" data-lang-key="login">Giriş Yap</button>
                    <button id="accountRegisterBtn" class="accent" data-lang-key="register">Kayıt Ol</button>
                </div>
                <span id="accountError" class="error-message" data-lang-key="accountError">Hatalı kullanıcı adı veya şifre.</span>
            </div>
            <div id="accountLoggedIn">
                <span id="accountWelcome"></span>
                <button id="accountLogoutBtn" class="accent" data-lang-key="logout">Çıkış Yap</button>
            </div>
        </div>
    </div>
<script type="module">
    import { translations } from './system/language.js';
    import { cacheBackgroundImage, selectColor, rgbToHex, applySettings, bindShortcuts, updateSearchEnginePreview, loadCachedBackground, fetchWeather, startWeatherUpdate } from './system/settings.js';

    // Dil değiştirme fonksiyonu
    function updateLanguage(lang) {
        if (typeof translations === "undefined" || !translations[lang]) {
            return;
        }
        if (typeof translations === "undefined" || !translations[lang]) {
    console.error("translations tanımlı değil, varsayılan Türkçe kullanılıyor.");
    document.getElementById("weatherWidget").innerHTML = `<span class="weather-error">Hava durumu alınamadı</span>`;
    return;
}
        document.documentElement.lang = lang;
        const elements = document.querySelectorAll('[data-lang-key]');
        elements.forEach(el => {
            const key = el.getAttribute('data-lang-key');
            if (translations[lang] && translations[lang][key]) {
                if (el.tagName === 'INPUT' && el.type === 'text') {
                    el.placeholder = translations[lang][key];
                } else if (el.tagName === 'OPTION') {
                    el.textContent = translations[lang][key];
                } else {
                    el.textContent = translations[lang][key];
                }
            }
        });

        document.getElementById('searchInput').placeholder = translations[lang].searchPlaceholder;
        document.getElementById('modalName').placeholder = translations[lang].favoritePlaceholder;
        document.getElementById('modalUrl').placeholder = translations[lang].urlPlaceholder;
        document.getElementById('weatherLocation').placeholder = translations[lang].weatherLocationPlaceholder;
        document.getElementById('languageDisplay').textContent = translations[lang].languageDisplay;
        document.getElementById('addFavoriteBtn').textContent = translations[lang].addFavorite;
        document.getElementById('accountError').textContent = translations[lang].accountError || 'Hatalı kullanıcı adı veya şifre.';
    }

    // Debounce fonksiyonu
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    async function search(type = 'web') {
        const q = document.getElementById("searchInput").value.trim();
        const suggestionsBox = document.getElementById("suggestions");
        suggestionsBox.style.display = "none";
        if (!q) return;
        const engine = localStorage.getItem("searchEngine") || "google";
        const linkBehavior = localStorage.getItem("linkBehavior") || "newTab";
        const aiProvider = localStorage.getItem("aiProvider") || "grok";
        const customAiUrl = localStorage.getItem("customAiUrl") || "";
        const lang = localStorage.getItem("language") || "tr";
        let url;

        if (type === "ai") {
            if (aiProvider === "custom" && !customAiUrl) {
                alert(translations[lang].invalidAiUrl || "Geçersiz veya eksik AI sitesi URL'si!");
                return;
            }
            if (aiProvider === "grok") {
                url = `https://grok.x.ai/?query=${encodeURIComponent(q)}`;
            } else if (aiProvider === "chatgpt") {
                url = `https://chat.openai.com/?q=${encodeURIComponent(q)}`;
            } else if (aiProvider === "claude") {
                url = `https://claude.anthropic.com/?q=${encodeURIComponent(q)}`;
            } else if (aiProvider === "custom") {
                try {
                    new URL(customAiUrl);
                    url = `${customAiUrl}?q=${encodeURIComponent(q)}`;
                } catch {
                    alert(translations[lang].invalidAiUrl || "Geçersiz AI sitesi URL'si!");
                    return;
                }
            }
        } else {
            if (engine === "yandex") {
                if (type === 'images') {
                    url = `https://yandex.com/images/search?text=${encodeURIComponent(q)}`;
                } else if (type === 'news') {
                    url = `https://news.yandex.com/search?text=${encodeURIComponent(q)}`;
                } else {
                    url = `https://yandex.com/search/?text=${encodeURIComponent(q)}`;
                }
            } else if (engine === "bing") {
                if (type === 'images') {
                    url = `https://www.bing.com/images/search?q=${encodeURIComponent(q)}`;
                } else if (type === 'shopping') {
                    url = `https://www.bing.com/shop?q=${encodeURIComponent(q)}`;
                } else if (type === 'news') {
                    url = `https://www.bing.com/news/search?q=${encodeURIComponent(q)}`;
                } else {
                    url = `https://www.bing.com/search?q=${encodeURIComponent(q)}`;
                }
            } else if (engine === "duckduckgo") {
                if (type === 'images') {
                    url = `https://duckduckgo.com/?q=${encodeURIComponent(q)}&iax=images&ia=images`;
                } else if (type === 'shopping') {
                    url = `https://duckduckgo.com/?q=${encodeURIComponent(q)}&ia=products`;
                } else if (type === 'news') {
                    url = `https://duckduckgo.com/?q=${encodeURIComponent(q)}&iar=news&ia=news`;
                } else {
                    url = `https://duckduckgo.com/?q=${encodeURIComponent(q)}`;
                }
            } else if (engine === "google") {
                if (type === 'images') {
                    url = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(q)}`;
                } else if (type === 'shopping') {
                    url = `https://www.google.com/search?tbm=shop&q=${encodeURIComponent(q)}`;
                } else if (type === 'news') {
                    url = `https://www.google.com/search?tbm=nws&q=${encodeURIComponent(q)}`;
                } else {
                    url = `https://www.google.com/search?q=${encodeURIComponent(q)}`;
                }
            } else if (engine === "yahoo") {
                if (type === 'images') {
                    url = `https://images.search.yahoo.com/search/images?p=${encodeURIComponent(q)}`;
                } else if (type === 'shopping') {
                    url = `https://shopping.yahoo.com/search?p=${encodeURIComponent(q)}`;
                } else if (type === 'news') {
                    url = `https://news.search.yahoo.com/search?p=${encodeURIComponent(q)}`;
                } else {
                    url = `https://search.yahoo.com/search?p=${encodeURIComponent(q)}`;
                }
            }
        }

        let searchHistory = JSON.parse(localStorage.getItem("searchHistory") || "[]");
        if (!searchHistory.includes(q)) {
            searchHistory.unshift(q);
            localStorage.setItem("searchHistory", JSON.stringify(searchHistory));
        }
        loadSearchHistory();
        document.getElementById("searchInput").value = "";
        if (linkBehavior === "closeCurrent") {
            window.location.href = url;
        } else {
            window.open(url, "_blank");
        }
    }

    function saveFavorites(favs) {
        try {
            localStorage.setItem("userFavorites", JSON.stringify(favs));
        } catch (e) {
            console.warn("Could not save favorites:", e);
        }
    }

    function loadFavorites() {
        const cont = document.getElementById("favorites");
        cont.innerHTML = "";
        let favs = [];
        let maxFav = 5;
        let linkBehavior = "newTab";
        let lang = "tr";
        try {
            const storedFavs = localStorage.getItem("userFavorites");
            favs = storedFavs ? JSON.parse(storedFavs) : [];
            if (!Array.isArray(favs)) {
                console.warn("userFavorites geçersiz formatta, sıfırlanıyor.");
                favs = [];
                localStorage.setItem("userFavorites", "[]");
            }
            maxFav = parseInt(localStorage.getItem("maxFavorites") || "5");
            linkBehavior = localStorage.getItem("linkBehavior") || "newTab";
            lang = localStorage.getItem("language") || "tr";
        } catch (e) {
            console.warn("Favoriler yüklenemedi, sıfırlanıyor:", e);
            localStorage.setItem("userFavorites", "[]");
        }

        favs.forEach((f, i) => {
            if (!f.url || !f.name) {
                console.warn(`Geçersiz favori atlanıyor: ${JSON.stringify(f)}`);
                return;
            }
            let faviconUrl = "ico/default-favicon.png";
            try {
                faviconUrl = `https://www.google.com/s2/favicons?domain=${new URL(f.url).hostname}`;
            } catch (e) {
                console.warn(`Geçersiz URL: ${f.url}`, e);
            }

            const btn = document.createElement("div");
            btn.className = "favorite-item";
            btn.setAttribute("draggable", "true");
            btn.setAttribute("data-index", i);
            btn.innerHTML = `
                <div style="display:flex; flex-direction: column; align-items: center; gap:4px; text-align: center;">
                    <img src="${faviconUrl}" style="width:32px;height:32px;border-radius:6px;" onerror="this.src='ico/default-favicon.png'">
                    <a href="${f.url}" ${linkBehavior === "closeCurrent" ? "" : 'target="_blank"'}>${f.name}</a>
                </div>
                <span class="remove-btn">×</span>`;
            btn.addEventListener("dragstart", handleDragStart);
            btn.addEventListener("dragover", handleDragOver);
            btn.addEventListener("drop", handleDrop);
            const removeBtn = btn.querySelector(".remove-btn");
            removeBtn.addEventListener("click", () => removeFavorite(i));
            cont.appendChild(btn);
        });

        const addBtn = document.createElement("div");
        addBtn.id = "addFavoriteBtn";
        addBtn.className = "favorite-item accent";
        addBtn.textContent = translations[lang]?.addFavorite || "+ Favori Ekle";
        addBtn.onclick = () => {
            document.getElementById("addFavoriteModal").style.display = "block";
            document.getElementById("modalName").focus();
        };
        cont.appendChild(addBtn);
        document.getElementById("addFavoriteBtn").style.display = favs.length >= maxFav ? "none" : "flex";
    }

    function removeFavorite(i) {
        const favs = JSON.parse(localStorage.getItem("userFavorites") || "[]");
        favs.splice(i, 1);
        saveFavorites(favs);
        loadFavorites();
    }

    let draggedIndex = null;

    function handleDragStart(e) {
        draggedIndex = e.target.getAttribute("data-index");
        e.dataTransfer.setData("text/plain", draggedIndex);
    }

    function handleDragOver(e) {
        e.preventDefault();
    }

    function handleDrop(e) {
        e.preventDefault();
        const droppedItem = e.target.closest(".favorite-item");
        if (!droppedItem) return;
        const droppedIndex = droppedItem.getAttribute("data-index");
        if (draggedIndex !== null && droppedIndex !== null && draggedIndex !== droppedIndex) {
            const favs = JSON.parse(localStorage.getItem("userFavorites") || "[]");
            const draggedFav = favs[draggedIndex];
            favs.splice(draggedIndex, 1);
            favs.splice(droppedIndex, 0, draggedFav);
            saveFavorites(favs);
            loadFavorites();
        }
        draggedIndex = null;
    }

    async function addFavoriteFromModal() {
        const name = document.getElementById("modalName").value.trim();
        let url = document.getElementById("modalUrl").value.trim();
        const lang = localStorage.getItem("language") || "tr";
        if (!url) {
            alert(translations[lang].invalidUrlAlert);
            return;
        }
        if (!url.startsWith("http://") && !url.startsWith("https://")) {
            url = "https://" + url;
        }
        try {
            new URL(url);
            const favs = JSON.parse(localStorage.getItem("userFavorites") || "[]");
            const maxFav = parseInt(localStorage.getItem("maxFavorites") || "5");
            if (favs.length >= maxFav) {
                alert(translations[lang].maxFavoritesAlert);
                return;
            }
            const finalName = name || await fetchWebsiteTitle(url);
            favs.push({ name: finalName, url });
            saveFavorites(favs);
            loadFavorites();
            document.getElementById("addFavoriteModal").style.display = "none";
            document.getElementById("modalName").value = "";
            document.getElementById("modalUrl").value = "";
        } catch {
            alert(translations[lang].invalidUrlAlert);
        }
    }

    async function fetchWebsiteTitle(url) {
        try {
            const response = await fetch(url);
            const text = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, "text/html");
            return doc.title || url;
        } catch {
            return url;
        }
    }

    function loadSearchHistory() {
        const lang = localStorage.getItem("language") || "tr";
        const historyList = document.getElementById("historyList");
        if (historyList) {
            historyList.innerHTML = "";
            const history = JSON.parse(localStorage.getItem("searchHistory") || "[]");
            if (history.length === 0) {
                const noHistoryMsg = document.createElement("li");
                noHistoryMsg.textContent = translations[lang]?.noHistory || "Geçmiş yok";
                historyList.appendChild(noHistoryMsg);
            } else {
                history.forEach(item => {
                    const li = document.createElement("li");
                    li.textContent = item;
                    li.className = "history-item";
                    li.onclick = () => {
                        document.getElementById("searchInput").value = item;
                        document.getElementById("suggestions").style.display = "none";
                        search();
                    };
                    historyList.appendChild(li);
                });
            }
        }
    }

    document.getElementById("voiceSearchBtn").onclick = () => {
        const lang = localStorage.getItem("language") || "tr";
        if (!("webkitSpeechRecognition" in window)) {
            alert(translations[lang].voiceSearchNotSupported);
            return;
        }

        const modal = document.getElementById("voiceSearchModal");
        const transcriptDiv = document.getElementById("voiceTranscript");
        modal.style.display = "block";
        transcriptDiv.textContent = translations[lang].voiceSearch || "Söyledikleriniz burada görünecek...";

        const recognition = new webkitSpeechRecognition();
        const langMap = {
            "tr": "tr-TR",
            "en": "en-US",
            "es": "es-ES",
            "ru": "ru-RU",
            "jp": "ja-JP",
            "zh": "zh-CN",
            "ko": "ko-KR",
            "de": "de-DE",
            "fr": "fr-FR",
            "ar": "ar-SA",
            "az": "az-AZ",
            "tk": "tk-TM",
            "kk": "kk-KZ",
            "ky": "ky-KG",
            "uz": "uz-UZ",
            "tt": "tt-RU",
            "ba": "ba-RU",
            "ug": "ug-CN",
            "sah": "sah-RU",
            "cv": "cv-RU",
            "gag": "gag-TR"
        };
        recognition.lang = langMap[lang] || "en-US";
        recognition.interimResults = true;
        recognition.continuous = false;
        recognition.maxAlternatives = 1;

        recognition.start();

        recognition.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript = transcript.trim();
                    transcriptDiv.textContent = finalTranscript;
                    document.getElementById("searchInput").value = finalTranscript;
                } else {
                    interimTranscript += transcript;
                    transcriptDiv.textContent = interimTranscript.trim() || translations[lang].voiceSearch;
                }
            }
        };

        recognition.onerror = (event) => {
            console.error("Ses tanıma hatası:", event.error);
            transcriptDiv.textContent = `${translations[lang].voiceSearchNotSupported} (Hata: ${event.error})`;
            recognition.stop();
        };

        recognition.onend = () => {
            console.log("Ses tanıma sona erdi.");
            document.getElementById("voiceIcon").classList.remove("active");
        };

        document.getElementById("confirmVoiceBtn").onclick = () => {
            if (document.getElementById("searchInput").value.trim()) {
                search();
                modal.style.display = "none";
            }
        };

        const voiceIcon = document.getElementById("voiceIcon");

        recognition.onstart = () => {
            console.log("Ses tanıma başladı");
            voiceIcon.classList.add("active");
        };

        recognition.onend = () => {
            console.log("Ses tanıma bitti");
            voiceIcon.classList.remove("active");
        };

        document.getElementById("cancelVoiceBtn").onclick = () => {
            recognition.stop();
            modal.style.display = "none";
            transcriptDiv.textContent = translations[lang].voiceSearch || "Söyledikleriniz burada görünecek...";
        };

        setTimeout(() => {
            if (recognition && recognition.state === "recording") {
                recognition.stop();
                transcriptDiv.textContent = translations[lang].voiceSearchNotSupported + " (Zaman aşımı)";
                modal.style.display = "none";
            }
        }, 10000);
    };

document.getElementById("menuButton").addEventListener("click", (e) => {
    e.stopPropagation();
    const p = document.getElementById("menuPanel");
    p.style.display = p.style.display === "block" ? "none" : "block";
    const accountModal = document.getElementById("accountModal");
    accountModal.style.display = "none";
    accountModal.classList.remove("active");
    // Varsayılan olarak Ayarlar sekmesini aç
    document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));
    document.getElementById("settingsContent").classList.add("active");
    document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
    document.querySelector(".tab-button[data-tab='settings']").classList.add("active");
    loadSearchHistory(); // Geçmiş sekmesi için geçmiş yükle
});

// Sekme geçişleri
document.querySelectorAll(".tab-button").forEach(button => {
    button.addEventListener("click", () => {
        const tab = button.getAttribute("data-tab");
        document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));
        document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
        document.getElementById(`${tab}Content`).classList.add("active");
        button.classList.add("active");
        if (tab === "history") {
            loadSearchHistory();
        }
    });
});

document.getElementById("applySettingsBtn").addEventListener("click", () => {
    applySettings(loadCachedBackground, updateLanguage, loadFavorites, updateSearchEnginePreview, fetchWeather, bindShortcuts, startWeatherUpdate);
    document.getElementById("menuPanel").style.display = "none";
    const accountModal = document.getElementById("accountModal");
    accountModal.style.display = "none";
    accountModal.classList.remove("active");
});

document.getElementById("clearHistoryBtn").onclick = () => {
    localStorage.setItem("searchHistory", "[]");
    loadSearchHistory();
};

    document.getElementById("searchEngineSelect").addEventListener("change", updateSearchEnginePreview);

    document.getElementById("addFavoriteModalBtn").addEventListener("click", addFavoriteFromModal);

    document.querySelectorAll('.color-option').forEach(option => {
        option.onclick = () => {
            const color = option.style.backgroundColor;
            const hexColor = rgbToHex(color);
            selectColor(hexColor);
        };
    });

    // Account system logic
    function updateAccountUI() {
        const username = localStorage.getItem("accountUsername");
        const info = document.getElementById("accountInfo");
        const btn = document.getElementById("accountButton");
        if (username) {
            info.textContent = `| 👤 ${username}`;
            btn.title = translations[localStorage.getItem("language") || "tr"].accountLoggedIn || "Hesap (Çıkış için tıkla)";
        } else {
            info.textContent = "|";
            btn.title = translations[localStorage.getItem("language") || "tr"].accountLogin || "Hesap (Giriş için tıkla)";
        }
    }

    function showAccountModal() {
        const modal = document.getElementById("accountModal");
        const username = localStorage.getItem("accountUsername");
        const errorMsg = document.getElementById("accountError");
        errorMsg.style.display = "none";
        if (username) {
            document.getElementById("accountForm").style.display = "none";
            document.getElementById("accountLoggedIn").style.display = "flex";
            document.getElementById("accountWelcome").textContent = `${translations[localStorage.getItem("language") || "tr"].welcome || "Hoşgeldin"}, ${username}!`;
        } else {
            document.getElementById("accountForm").style.display = "flex";
            document.getElementById("accountLoggedIn").style.display = "none";
            document.getElementById("accountUsername").value = "";
            document.getElementById("accountPassword").value = "";
        }
        modal.style.display = "block";
        modal.classList.add("active");
    }

    function closeAccountPanel() {
        const modal = document.getElementById("accountModal");
        modal.style.display = "none";
        modal.classList.remove("active");
    }

    function updateAccountModalTheme() {
        const theme = localStorage.getItem("theme") || "dark";
        const inner = document.getElementById("accountModalInner");
        if (!inner) return;
        inner.classList.remove("dark", "light");
        inner.classList.add(theme === "light" ? "light" : "dark");
    }

    window.closeAccountPanel = closeAccountPanel;

    document.getElementById("accountButton").onclick = showAccountModal;

    document.getElementById("accountLoginBtn").onclick = () => {
        const username = document.getElementById("accountUsername").value.trim();
        const password = document.getElementById("accountPassword").value.trim();
        const errorMsg = document.getElementById("accountError");
        const lang = localStorage.getItem("language") || "tr";
        errorMsg.style.display = "none";

        if (username.length < 2) {
            errorMsg.textContent = translations[lang].usernameTooShort || "Kullanıcı adı en az 2 karakter olmalı.";
            errorMsg.style.display = "block";
            return;
        }
        if (password.length < 4) {
            errorMsg.textContent = translations[lang].passwordTooShort || "Şifre en az 4 karakter olmalı.";
            errorMsg.style.display = "block";
            return;
        }

        const storedUsers = JSON.parse(localStorage.getItem("users") || "{}");
        if (storedUsers[username] && storedUsers[username].password === password) {
            localStorage.setItem("accountUsername", username);
            updateAccountUI();
            showAccountModal();
        } else {
            errorMsg.textContent = translations[lang].accountError || "Hatalı kullanıcı adı veya şifre.";
            errorMsg.style.display = "block";
        }
    };

    document.getElementById("accountRegisterBtn").onclick = () => {
        const username = document.getElementById("accountUsername").value.trim();
        const password = document.getElementById("accountPassword").value.trim();
        const errorMsg = document.getElementById("accountError");
        const lang = localStorage.getItem("language") || "tr";
        errorMsg.style.display = "none";

        if (username.length < 2) {
            errorMsg.textContent = translations[lang].usernameTooShort || "Kullanıcı adı en az 2 karakter olmalı.";
            errorMsg.style.display = "block";
            return;
        }
        if (password.length < 4) {
            errorMsg.textContent = translations[lang].passwordTooShort || "Şifre en az 4 karakter olmalı.";
            errorMsg.style.display = "block";
            return;
        }

        const storedUsers = JSON.parse(localStorage.getItem("users") || "{}");
        if (storedUsers[username]) {
            errorMsg.textContent = translations[lang].usernameTaken || "Bu kullanıcı adı zaten alınmış.";
            errorMsg.style.display = "block";
            return;
        }

        storedUsers[username] = { password };
        localStorage.setItem("users", JSON.stringify(storedUsers));
        localStorage.setItem("accountUsername", username);
        updateAccountUI();
        showAccountModal();
    };

    document.getElementById("accountLogoutBtn").onclick = () => {
        localStorage.removeItem("accountUsername");
        updateAccountUI();
        closeAccountPanel();
    };

    function bindAccountShortcut() {
        const accountShortcut = localStorage.getItem("accountShortcut") || "Ctrl + Shift + A";
        document.addEventListener("keydown", (e) => {
            const keyCombo = `${e.ctrlKey ? 'Ctrl + ' : ''}${e.shiftKey ? 'Shift + ' : ''}${e.key}`;
            if (keyCombo === accountShortcut) {
                e.preventDefault();
                showAccountModal();
            }
        });
    }

    window.onload = () => {
        if (typeof translations === "undefined") {
            setTimeout(window.onload, 50);
            return;
        }
        const bg = localStorage.getItem("bgUrl") || "https://images.pexels.com/photos/19161533/pexels-photo-19161533.jpeg";
        const f = localStorage.getItem("font") || "'Open Sans', sans-serif";
        const t = localStorage.getItem("theme") || "dark";
        const c = localStorage.getItem("accentColor") || "#00bcd4";
        const l = localStorage.getItem("language") || "tr";
        const se = localStorage.getItem("searchEngine") || "google";
        const sf = localStorage.getItem("showFavorites") || "true";
        const ss = localStorage.getItem("showSuggestions") || "true";
        const sw = localStorage.getItem("showWeather") || "true";
        const si = localStorage.getItem("showInfoBar") || "true";
        const ld = localStorage.getItem("logoDisplay") || "logo-name";
        const maxFav = localStorage.getItem("maxFavorites") || "5";
        const searchShortcut = localStorage.getItem("searchShortcut") || "Ctrl + /";
        const favoriteShortcut = localStorage.getItem("favoriteShortcut") || "Ctrl + Shift + F";
        const settingsShortcut = localStorage.getItem("settingsShortcut") || "Ctrl + Shift + X";
        const historyShortcut = localStorage.getItem("historyShortcut") || "Ctrl + Shift + H";
        const imagesShortcut = localStorage.getItem("imagesShortcut") || "Ctrl + i";
        const shoppingShortcut = localStorage.getItem("shoppingShortcut") || "Ctrl + S";
        const newsShortcut = localStorage.getItem("newsShortcut") || "Ctrl + N";
        const accountShortcut = localStorage.getItem("accountShortcut") || "Ctrl + Shift + A";
        const aiShortcut = localStorage.getItem("aiShortcut") || "Ctrl + Shift + I";
        const weatherLocation = localStorage.getItem("weatherLocation") || "";
        const weatherUpdateInterval = localStorage.getItem("weatherUpdateInterval") || "10";
        const linkBehavior = localStorage.getItem("linkBehavior") || "newTab";
        const aiProvider = localStorage.getItem("aiProvider") || "grok";
        const customAiUrl = localStorage.getItem("customAiUrl") || "";
        const showAISearch = localStorage.getItem("showAISearch") === "False";
        localStorage.setItem("weatherAPI", "wttrin"); // Varsayılan olarak wttr.in
        localStorage.setItem("openWeatherMapApiKey", ""); // Varsayılan olarak boş
        localStorage.setItem("weatherApiKey", ""); // Varsayılan olarak boş
        localStorage.setItem("visualCrossingApiKey", ""); // Varsayılan olarak boş

        document.getElementById("bgUrlInput").value = bg;
        document.getElementById("fontSelect").value = f;
        document.getElementById("themeSelect").value = t;
        document.getElementById("accentColor").value = c;
        document.getElementById("languageSelect").value = l;
        document.getElementById("searchEngineSelect").value = se;
        document.getElementById("showFavorites").value = sf;
        document.getElementById("showSuggestions").value = ss;
        document.getElementById("showWeather").value = sw;
        document.getElementById("showInfoBar").value = si;
        document.getElementById("logoDisplaySelect").value = ld;
        document.getElementById("maxFavorites").value = maxFav;
        document.getElementById("searchShortcutInput").value = searchShortcut;
        document.getElementById("favoriteShortcutInput").value = favoriteShortcut;
        document.getElementById("settingsShortcutInput").value = settingsShortcut;
        document.getElementById("historyShortcutInput").value = historyShortcut;
        document.getElementById("imagesShortcutInput").value = imagesShortcut;
        document.getElementById("shoppingShortcutInput").value = shoppingShortcut;
        document.getElementById("newsShortcutInput").value = newsShortcut;
        document.getElementById("accountShortcutInput").value = accountShortcut;
        document.getElementById("aiShortcutInput").value = aiShortcut;
        document.getElementById("weatherLocation").value = weatherLocation;
        document.getElementById("weatherUpdateInterval").value = weatherUpdateInterval;
        document.getElementById("linkBehavior").value = linkBehavior;
        document.getElementById("aiProviderSelect").value = aiProvider;
        document.getElementById("customAiUrl").value = customAiUrl;
        document.getElementById("showAISearch").checked = showAISearch;
        document.getElementById("searchAIBtn").style.display = showAISearch ? "inline-block" : "none";
        document.getElementById("weatherAPI").value = localStorage.getItem("weatherAPI") || "openweathermap";

        document.getElementById("searchWebBtn").addEventListener("click", () => search("web"));
        document.getElementById("searchImagesBtn").addEventListener("click", () => search("images"));
        document.getElementById("searchShoppingBtn").addEventListener("click", () => search("shopping"));
        document.getElementById("searchNewsBtn").addEventListener("click", () => search("news"));
        document.getElementById("searchAIBtn").addEventListener("click", () => search("ai"));

        document.getElementById("weatherAPI").addEventListener("change", (e) => {
            localStorage.setItem("weatherAPI", e.target.value);
            fetchWeather();
        });

document.getElementById("weatherAPI").addEventListener("change", (e) => {
    const api = e.target.value;
    document.getElementById("openWeatherMapKeyInput").classList.toggle("active", api === "openweathermap");
    document.getElementById("weatherApiKeyInput").classList.toggle("active", api === "weatherapi");
    document.getElementById("visualCrossingKeyInput").classList.toggle("active", api === "visualcrossing");
});

        fetchWeather();
        startWeatherUpdate();
        applySettings(loadCachedBackground, updateLanguage, loadFavorites, updateSearchEnginePreview, fetchWeather, bindShortcuts, startWeatherUpdate);
        updateAccountModalTheme();
        bindAccountShortcut();
        updateAccountUI();

        const searchInput = document.getElementById("searchInput");
        const suggestionsBox = document.getElementById("suggestions");
        let selectedIndex = -1;

        function fetchSuggestions(query) {
            if (localStorage.getItem("showSuggestions") === "false") return;
            const encodedQuery = encodeURIComponent(query.trim());
            const callbackName = "jsonpCallback_" + Math.random().toString(36).substr(2);
            window[callbackName] = function(data) {
                try {
                    console.log("Google Suggest JSONP yanıtı:", data);
                    const suggestionsBox = document.getElementById("suggestions");
                    suggestionsBox.innerHTML = "";
                    const suggestions = data[1].slice(0, 8);
                    suggestionsBox.style.display = suggestions.length ? "block" : "none";
                    suggestions.forEach(suggestion => {
                        const li = document.createElement("li");
                        li.textContent = suggestion;
                        li.onclick = () => {
                            document.getElementById("searchInput").value = suggestion;
                            search();
                            suggestionsBox.style.display = "none";
                        };
                        suggestionsBox.appendChild(li);
                    });
                    selectedIndex = -1;
                } catch (e) {
                    console.error("Öneri alınamadı:", e);
                    const suggestionsBox = document.getElementById("suggestions");
                    suggestionsBox.innerHTML = `<li style="padding: 12px; color: #ff4444;">${translations[localStorage.getItem("language") || "tr"].noSuggestions}</li>`;
                    suggestionsBox.style.display = "block";
                } finally {
                    delete window[callbackName];
                }
            };
            const script = document.createElement("script");
            script.src = `https://suggestqueries.google.com/complete/search?client=firefox&q=${encodedQuery}&jsonp=${callbackName}`;
            script.onload = () => {
                script.remove();
            };
            script.onerror = () => {
                console.error("Öneri alınamadı: Script yüklenemedi");
                const suggestionsBox = document.getElementById("suggestions");
                suggestionsBox.innerHTML = `<li style="padding: 12px; color: #ff4444;">${translations[localStorage.getItem("language") || "tr"].noSuggestions}</li>`;
                suggestionsBox.style.display = "block";
                delete window[callbackName];
                script.remove();
            };
            document.body.appendChild(script);
        }

        const debouncedFetchSuggestions = debounce(fetchSuggestions, 200);

        searchInput.addEventListener("input", () => {
            const query = searchInput.value.trim();
            if (query) {
                debouncedFetchSuggestions(query);
            } else {
                suggestionsBox.style.display = "none";
            }
        });

        searchInput.addEventListener("keydown", (e) => {
            const suggestions = suggestionsBox.querySelectorAll("li");
            if (e.key === "ArrowDown") {
                e.preventDefault();
                if (selectedIndex < suggestions.length - 1) {
                    selectedIndex++;
                    suggestions.forEach((li, i) => {
                        li.classList.toggle("selected", i === selectedIndex);
                    });
                    suggestionsBox.scrollTop = suggestions[selectedIndex]?.offsetTop - suggestionsBox.offsetHeight / 2;
                }
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                if (selectedIndex > -1) {
                    selectedIndex--;
                    suggestions.forEach((li, i) => {
                        li.classList.toggle("selected", i === selectedIndex);
                    });
                    suggestionsBox.scrollTop = suggestions[selectedIndex]?.offsetTop - suggestionsBox.offsetHeight / 2;
                }
            } else if (e.key === "Enter") {
                e.preventDefault();
                if (selectedIndex > -1 && suggestions[selectedIndex]) {
                    searchInput.value = suggestions[selectedIndex].textContent;
                    suggestionsBox.style.display = "none";
                    search();
                } else if (searchInput.value.trim()) {
                    search();
                }
            } else if (e.key === "Escape") {
                suggestionsBox.style.display = "none";
            }
        });

document.addEventListener("click", (e) => {
    if (!e.target.closest("#menuPanel") && !e.target.closest("#menuButton")) {
        document.getElementById("menuPanel").style.display = "none";
    }
    if (!e.target.closest("#searchBar") && !e.target.closest("#suggestions")) {
        suggestionsBox.style.display = "none";
    }
    if (!e.target.closest("#addFavoriteModal") && !e.target.closest("#addFavoriteBtn")) {
        document.getElementById("addFavoriteModal").style.display = "none";
    }
    if (!e.target.closest("#accountModal") && !e.target.closest("#accountButton")) {
        const accountModal = document.getElementById("accountModal");
        accountModal.style.display = "none";
        accountModal.classList.remove("active");
    }
    if (!e.target.closest("#voiceSearchModal") && !e.target.closest("#voiceSearchBtn")) {
        document.getElementById("voiceSearchModal").style.display = "none";
    }
});
    };
</script>

