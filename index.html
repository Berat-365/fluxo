<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxo Page</title>
    <link rel="icon" type="image/icon" href="ico/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <video id="backgroundVideo" autoplay loop muted playsinline preload="auto" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; will-change: transform;">
        <source src="" type="video/mp4">
    </video>
    <iframe id="backgroundYouTube" frameborder="0" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; object-fit: cover; transform: scale(1.1); will-change: transform;" allow="autoplay; encrypted-media"></iframe>
    <div class="weather-widget" id="weatherWidget" onclick="window.open('https://wttr.in', '_blank')">Yükleniyor...</div>
    <div class="info-bar" id="infoBar">Fluxo 3.7,2 | Vanilla | <span id="languageDisplay">Türkçe</span></div>
    <div class="url-sidebar" id="urlSidebar"></div>
    <button id="settingsButton">
        <img id="settingsIcon" src="ico/settings.png" alt="Ayarlar">
    </button>
    <button id="historyButton">
        <img id="historyIcon" src="ico/history.png" alt="Geçmiş Aramalar">
    </button>
    <div id="settingsPanel">
        <button id="applySettingsBtn" class="accent" data-lang-key="apply">Uygula</button>
        <button id="clearHistoryBtn" class="accent" data-lang-key="clearHistory">Geçmişi Temizle</button>
        <h3 data-lang-key="personalization">Kişiselleştirme</h3>
        <label for="bgUrlInput" data-lang-key="bgUrl">Arka Plan URL (Resim, Video veya YouTube):</label>
        <input type="text" id="bgUrlInput" placeholder="https://... (jpg, png, mp4, webm, ogg, youtube.com)">
        <div id="recentBgList" style="margin-top: 5px;"></div>
        <label for="fontSelect" data-lang-key="font">Yazı Tipi:</label>
        <select id="fontSelect">
            <option value="'Segoe UI', sans-serif">Segoe UI</option>
            <option value="'Arial', sans-serif">Arial</option>
            <option value="'Courier New', monospace">Courier New</option>
            <option value="'Georgia', serif">Georgia</option>
            <option value="'Roboto', sans-serif">Roboto</option>
            <option value="'Open Sans', sans-serif">Open Sans</option>
            <option value="'Lato', sans-serif">Lato</option>
            <option value="'Montserrat', sans-serif">Montserrat</option>
            <option value="'Inter', sans-serif">Inter</option> 
        </select>
        <label for="themeSelect" data-lang-key="theme">Renk Teması:</label>
        <select id="themeSelect">
            <option value="dark" data-lang-key="dark">Koyu</option>
            <option value="light" data-lang-key="light">Açık</option>
        </select>
        <label for="accentColor" data-lang-key="accentColor">Vurgu Rengi:</label>
        <div id="colorPalette" class="flex flex-wrap gap-2 mt-2">
            <div class="color-option" style="background-color: #00bcd4 !important;" onclick="selectColor('#00bcd4')"></div>
            <div class="color-option" style="background-color: #ff5722 !important;" onclick="selectColor('#ff5722')"></div>
            <div class="color-option" style="background-color: #4caf50 !important;" onclick="selectColor('#4caf50')"></div>
            <div class="color-option" style="background-color: #9c27b0 !important;" onclick="selectColor('#9c27b0')"></div>
            <div class="color-option" style="background-color: #ffeb3b !important;" onclick="selectColor('#ffeb3b')"></div>
        </div>
        <input type="color" id="accentColor" value="#00bcd4">
        <label for="languageSelect" data-lang-key="language">Dil:</label>
        <select id="languageSelect">
            <option value="tr" data-lang-key="turkish">Türkçe</option>
            <option value="en" data-lang-key="english">English</option>
            <option value="es" data-lang-key="spanish">Español</option>
            <option value="ru" data-lang-key="russian">Русский</option>
            <option value="jp" data-lang-key="japanese">日本語</option>
            <option value="zh" data-lang-key="chinese">中文</option>
            <option value="ko" data-lang-key="korean">한국어</option>
            <option value="de" data-lang-key="german">Deutsch</option>
            <option value="fr" data-lang-key="french">Français</option>
            <option value="ar" data-lang-key="arabic">العربية</option>
            <option value="az" data-lang-key="azerbaijani">Azərbaycan dili</option>
            <option value="tk" data-lang-key="turkmen">Türkmençe</option>
            <option value="kk" data-lang-key="kazakh">Қазақша</option>
            <option value="ky" data-lang-key="kyrgyz">Кыргызча</option>
            <option value="uz" data-lang-key="uzbek">O'zbekcha</option>
            <option value="tt" data-lang-key="tatar">Татарча</option>
            <option value="ba" data-lang-key="bashkir">Башкортса</option>
            <option value="ug" data-lang-key="uyghur">ئۇيغۇرچە</option>
            <option value="sah" data-lang-key="yakut">Саха тыла</option>
            <option value="cv" data-lang-key="chuvash">Чӑваш чӗлхи</option>
            <option value="gag" data-lang-key="gagavuz">Gagavuzca</option>
        </select>
        <label for="logoDisplaySelect" data-lang-key="logoDisplay">Logo Görüntüleme:</label>
        <select id="logoDisplaySelect">
            <option value="logo" data-lang-key="logoOnly">Sadece Logo</option>
            <option value="logo-name" data-lang-key="logoAndName">Logo ve İsim</option>
            <option value="none" data-lang-key="none">Hiçbiri</option>
        </select>
        <h3 data-lang-key="system">Sistem</h3>
        <label for="searchEngineSelect" data-lang-key="searchEngine">Arama Motoru:</label>
        <select id="searchEngineSelect">
            <option value="google">Google</option>
            <option value="bing">Bing</option>
            <option value="duckduckgo">DuckDuckGo</option>
            <option value="yandex">Yandex</option>
            <option value="yahoo">Yahoo</option>
        </select>
        <div id="searchEnginePreview" style="margin-top: 10px; text-align: center;">
            <img src="" alt="Arama Motoru Önizlemesi" style="max-height: 40px; display: none;" id="engineLogo">
        </div>
        <label for="showFavorites" data-lang-key="showFavorites">Favorileri Göster:</label>
        <select id="showFavorites">
            <option value="true" data-lang-key="yes">Evet</option>
            <option value="false" data-lang-key="no">Hayır</option>
        </select>
        <label for="maxFavorites" data-lang-key="maxFavorites">Maksimum Favori Sayısı:</label>
        <select id="maxFavorites">
            <option value="5">5</option>
            <option value="10">10</option>
        </select>
        <label for="showSuggestions" data-lang-key="showSuggestions">Arama Önerilerini Göster:</label>
        <select id="showSuggestions">
            <option value="true" data-lang-key="yes">Evet</option>
            <option value="false" data-lang-key="no">Hayır</option>
        </select>
        <label for="showWeather" data-lang-key="showWeather">Hava Durumunu Göster:</label>
        <select id="showWeather">
            <option value="true" data-lang-key="yes">Evet</option>
            <option value="false" data-lang-key="no">Hayır</option>
        </select>
        <label for="weatherLocation" data-lang-key="weatherLocation">Hava Durumu Konumu:</label>
        <input type="text" id="weatherLocation" placeholder="Şehir ismi">
        <label for="weatherUpdateInterval" data-lang-key="weatherUpdateInterval">Hava Durumu Güncelleme Sıklığı:</label>
        <select id="weatherUpdateInterval">
            <option value="5" data-lang-key="every5Min">Her 5 Dakika</option>
            <option value="10" data-lang-key="every10Min">Her 10 Dakika</option>
            <option value="30" data-lang-key="every30Min">Her 30 Dakika</option>
            <option value="0" data-lang-key="manual">Manuel</option>
        </select>
        <label for="linkBehavior" data-lang-key="linkBehavior">Link Davranışı:</label>
        <select id="linkBehavior">
            <option value="newTab" data-lang-key="newTab">Yeni Sekmede Aç</option>
            <option value="closeCurrent" data-lang-key="closeCurrent">Bu Sayfayı Kapat</option>
        </select>
        <label for="showInfoBar" data-lang-key="showInfoBar">Bilgi Barını Göster:</label>
        <select id="showInfoBar">
            <option value="true" data-lang-key="yes">Evet</option>
            <option value="false" data-lang-key="no">Hayır</option>
        </select>
        <h3 data-lang-key="shortcuts">Klavye Kısayolları</h3>
        <label for="searchShortcutInput" data-lang-key="searchShortcut">Arama Çubuğu:</label>
        <input type="text" id="searchShortcutInput" placeholder="Ör: Ctrl + /" value="Ctrl + /">
        <label for="favoriteShortcutInput" data-lang-key="favoriteShortcut">Favori Ekle:</label>
        <input type="text" id="favoriteShortcutInput" placeholder="Ör: Ctrl + Shift + F" value="Ctrl + Shift + F">
        <label for="settingsShortcutInput" data-lang-key="settingsShortcut">Ayarlar Paneli:</label>
        <input type="text" id="settingsShortcutInput" placeholder="Ör: Ctrl + Shift + S" value="Ctrl + Shift + S">
        <label for="historyShortcutInput" data-lang-key="historyShortcut">Geçmiş Paneli:</label>
        <input type="text" id="historyShortcutInput" placeholder="Ör: Ctrl + Shift + H" value="Ctrl + Shift + H">
        <label for="imagesShortcutInput" data-lang-key="imagesShortcut">Görseller Araması:</label>
        <input type="text" id="imagesShortcutInput" placeholder="Ör: Ctrl + I" value="Ctrl + I">
        <label for="shoppingShortcutInput" data-lang-key="shoppingShortcut">Alışveriş Araması:</label>
        <input type="text" id="shoppingShortcutInput" placeholder="Ör: Ctrl + S" value="Ctrl + S">
        <label for="newsShortcutInput" data-lang-key="newsShortcut">Haberler Araması:</label>
        <input type="text" id="newsShortcutInput" placeholder="Ör: Ctrl + N" value="Ctrl + N">
    </div>
    <div id="historyPanel">
        <h3 data-lang-key="searchHistory">Arama Geçmişi</h3>
        <div id="historyList"></div>
    </div>
    <div id="addFavoriteModal">
        <span class="close" onclick="document.getElementById('addFavoriteModal').style.display='none'">×</span>
        <label for="modalName" data-lang-key="favoriteName">İsim:</label>
        <input type="text" id="modalName" placeholder="Favori ismi">
        <label for="modalUrl" data-lang-key="favoriteUrl">URL:</label>
        <input type="text" id="modalUrl" placeholder="https://...">
        <button id="addFavoriteModalBtn" class="accent" data-lang-key="add">Ekle</button>
    </div>
    <div class="container">
        <div class="logo" id="logo">
            <a href="#" onclick="window.location.reload()">
                <img src="ico/logo.png" alt="Fluxo Logo" id="logoImg">
                <span class="logo-name" id="logoName">Fluxo</span>
            </a>
        </div>
        <div class="search-bar" id="searchBar">
            <span class="icon-left"><img id="searchIcon" src="ico/search.png" alt="Arama"></span>
            <input type="text" id="searchInput" placeholder="Arama yap..." autofocus>
            <span class="icon-right" id="voiceSearchBtn"><img id="voiceIcon" src="ico/mic.png" alt="Sesli Arama"></span>
            <ul id="suggestions" role="listbox" aria-label="Arama önerileri"></ul>
        </div>
        <div class="buttons">
            <button onclick="search('web')" class="accent" data-lang-key="search">Ara</button>
            <button onclick="search('images')" data-lang-key="images">Görseller</button>
            <button onclick="search('shopping')" data-lang-key="shopping">Alışveriş</button>
            <button onclick="search('news')" data-lang-key="news">Haberler</button>
        </div>
        <div class="favorites" id="favorites">
            <div id="addFavoriteBtn" class="favorite-item accent" data-lang-key="addFavorite">+ Favori Ekle</div>
        </div>
    </div>
    <script type="module">
        import { translations } from './lang/language.js';
        import { cacheBackgroundImage, selectColor, rgbToHex, applySettings, bindShortcuts, updateSearchEnginePreview, loadCachedBackground } from './panel/settings.js';

        // Dil değiştirme fonksiyonu
        function updateLanguage(lang) {
            if (typeof translations === "undefined" || !translations[lang]) {
                return;
            }
            document.documentElement.lang = lang;
            const elements = document.querySelectorAll('[data-lang-key]');
            elements.forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang] && translations[lang][key]) {
                    if (el.tagName === 'INPUT' && el.type === 'text') {
                        el.placeholder = translations[lang][key];
                    } else if (el.tagName === 'OPTION') {
                        el.textContent = translations[lang][key];
                    } else {
                        el.textContent = translations[lang][key];
                    }
                }
            });
            document.getElementById('searchInput').placeholder = translations[lang].searchPlaceholder;
            document.getElementById('modalName').placeholder = translations[lang].favoritePlaceholder;
            document.getElementById('modalUrl').placeholder = translations[lang].urlPlaceholder;
            document.getElementById('weatherLocation').placeholder = translations[lang].weatherLocationPlaceholder;
            document.getElementById('languageDisplay').textContent = translations[lang].languageDisplay;
            document.getElementById('addFavoriteBtn').textContent = translations[lang].addFavorite;
        }

        // Debounce fonksiyonu
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function fetchWeather() {
            const widget = document.getElementById("weatherWidget");
            const location = localStorage.getItem("weatherLocation") || "";
            try {
                const resp = await fetch(`https://wttr.in/${encodeURIComponent(location)}?format=%l:+%c+%t+%w`);
                if (!resp.ok) throw new Error("Weather fetch failed");
                const txt = await resp.text();
                widget.textContent = txt;
                widget.title = txt;
            } catch {
                widget.innerHTML = `<span class="weather-error">${
                    translations[localStorage.getItem("language") || "tr"].weatherError
                }</span>`;
            }
        }

        // Hava durumu güncelleme
        function startWeatherUpdate() {
            const interval = parseInt(localStorage.getItem("weatherUpdateInterval") || "10") * 60 * 1000;
            if (interval > 0) {
                setInterval(fetchWeather, interval);
            }
        }

        async function fetchWebsiteTitle(url) {
            try {
                const domain = new URL(url).hostname;
                const apiUrl = `https://api.duckduckgo.com/?q=${encodeURIComponent(domain)}&format=json&no_redirect=1&no_html=1`;
                const resp = await fetch(apiUrl);
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.Heading) return data.Heading;
                }
                return domain.split('.')[0] || "Site";
            } catch (e) {
                return "Site";
            }
        }

        function search(type = 'web') {
            const q = document.getElementById("searchInput").value.trim();
            const suggestionsBox = document.getElementById("suggestions");
            suggestionsBox.style.display = "none";
            if (!q) return;
            const engine = localStorage.getItem("searchEngine") || "google";
            const linkBehavior = localStorage.getItem("linkBehavior") || "newTab";
            let url;
            if (engine === "yandex") {
                if (type === 'images') {
                    url = `https://yandex.com/images/search?text=${encodeURIComponent(q)}`;
                } else if (type === 'news') {
                    url = `https://news.yandex.com/search?text=${encodeURIComponent(q)}`;
                } else {
                    url = `https://yandex.com/search/?text=${encodeURIComponent(q)}`;
                }
            } else if (engine === "bing") {
                if (type === 'images') {
                    url = `https://www.bing.com/images/search?q=${encodeURIComponent(q)}`;
                } else if (type === 'shopping') {
                    url = `https://www.bing.com/shop?q=${encodeURIComponent(q)}`;
                } else if (type === 'news') {
                    url = `https://www.bing.com/news/search?q=${encodeURIComponent(q)}`;
                } else {
                    url = `https://www.bing.com/search?q=${encodeURIComponent(q)}`;
                }
            } else if (engine === "duckduckgo") {
                if (type === 'images') {
                    url = `https://duckduckgo.com/?q=${encodeURIComponent(q)}&iax=images&ia=images`;
                } else if (type === 'shopping') {
                    url = `https://duckduckgo.com/?q=${encodeURIComponent(q)}&ia=products`;
                } else if (type === 'news') {
                    url = `https://duckduckgo.com/?q=${encodeURIComponent(q)}&iar=news&ia=news`;
                } else {
                    url = `https://duckduckgo.com/?q=${encodeURIComponent(q)}`;
                }
            } else if (engine === "google") {
                if (type === 'images') {
                    url = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(q)}`;
                } else if (type === 'shopping') {
                    url = `https://www.google.com/search?tbm=shop&q=${encodeURIComponent(q)}`;
                } else if (type === 'news') {
                    url = `https://www.google.com/search?tbm=nws&q=${encodeURIComponent(q)}`;
                } else {
                    url = `https://www.google.com/search?q=${encodeURIComponent(q)}`;
                }
            } else if (engine === "yahoo") {
                if (type === 'images') {
                    url = `https://images.search.yahoo.com/search/images?p=${encodeURIComponent(q)}`;
                } else if (type === 'shopping') {
                    url = `https://shopping.yahoo.com/search?p=${encodeURIComponent(q)}`;
                } else if (type === 'news') {
                    url = `https://news.search.yahoo.com/search?p=${encodeURIComponent(q)}`;
                } else {
                    url = `https://search.yahoo.com/search?p=${encodeURIComponent(q)}`;
                }
            }
            let searchHistory = JSON.parse(localStorage.getItem("searchHistory") || "[]");
            if (!searchHistory.includes(q)) {
                searchHistory.unshift(q);
                localStorage.setItem("searchHistory", JSON.stringify(searchHistory));
            }
            loadSearchHistory();
            document.getElementById("searchInput").value = "";
            if (linkBehavior === "closeCurrent") {
                window.location.href = url;
            } else {
                window.open(url, "_blank");
            }
        }

        function saveFavorites(favs) {
            try {
                localStorage.setItem("userFavorites", JSON.stringify(favs));
            } catch (e) {
                console.warn("Could not save favorites:", e);
            }
        }

        function loadFavorites() {
            const cont = document.getElementById("favorites");
            cont.innerHTML = "";
            let favs = [];
            let maxFav = 5;
            let linkBehavior = "newTab";
            let lang = "tr";
            try {
                const storedFavs = localStorage.getItem("userFavorites");
                favs = storedFavs ? JSON.parse(storedFavs) : [];
                if (!Array.isArray(favs)) {
                    console.warn("userFavorites geçersiz formatta, sıfırlanıyor.");
                    favs = [];
                    localStorage.setItem("userFavorites", "[]");
                }
                maxFav = parseInt(localStorage.getItem("maxFavorites") || "5");
                linkBehavior = localStorage.getItem("linkBehavior") || "newTab";
                lang = localStorage.getItem("language") || "tr";
            } catch (e) {
                console.warn("Favoriler yüklenemedi, sıfırlanıyor:", e);
                localStorage.setItem("userFavorites", "[]");
            }

            favs.forEach((f, i) => {
                if (!f.url || !f.name) {
                    console.warn(`Geçersiz favori atlanıyor: ${JSON.stringify(f)}`);
                    return; // Geçersiz favorileri atla
                }
                let faviconUrl = "ico/default-favicon.png";
                try {
                    faviconUrl = `https://www.google.com/s2/favicons?domain=${new URL(f.url).hostname}`;
                } catch (e) {
                    console.warn(`Geçersiz URL: ${f.url}`, e);
                }

                const btn = document.createElement("div");
                btn.className = "favorite-item";
                btn.setAttribute("draggable", "true");
                btn.setAttribute("data-index", i);
                btn.innerHTML = `
                    <div style="display:flex; flex-direction: column; align-items: center; gap:4px; text-align: center;">
                        <img src="${faviconUrl}" style="width:32px;height:32px;border-radius:6px;" onerror="this.src='ico/default-favicon.png'">
                        <a href="${f.url}" ${linkBehavior === "closeCurrent" ? "" : 'target="_blank"'}>${f.name}</a>
                    </div>
                    <span class="remove-btn">×</span>`;
                btn.addEventListener("dragstart", handleDragStart);
                btn.addEventListener("dragover", handleDragOver);
                btn.addEventListener("drop", handleDrop);
                const removeBtn = btn.querySelector(".remove-btn");
                removeBtn.addEventListener("click", () => removeFavorite(i));
                cont.appendChild(btn);
            });

            const addBtn = document.createElement("div");
            addBtn.id = "addFavoriteBtn";
            addBtn.className = "favorite-item accent";
            addBtn.textContent = translations[lang]?.addFavorite || "+ Favori Ekle";
            addBtn.onclick = () => {
                document.getElementById("addFavoriteModal").style.display = "block";
                document.getElementById("modalName").focus();
            };
            cont.appendChild(addBtn);
            document.getElementById("addFavoriteBtn").style.display = favs.length >= maxFav ? "none" : "flex";
        }

        function removeFavorite(i) {
            const favs = JSON.parse(localStorage.getItem("userFavorites") || "[]");
            favs.splice(i, 1);
            saveFavorites(favs);
            loadFavorites();
        }

        let draggedIndex = null;

        function handleDragStart(e) {
            draggedIndex = e.target.getAttribute("data-index");
            e.dataTransfer.setData("text/plain", draggedIndex);
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const droppedItem = e.target.closest(".favorite-item");
            if (!droppedItem) return;
            const droppedIndex = droppedItem.getAttribute("data-index");
            if (draggedIndex !== null && droppedIndex !== null && draggedIndex !== droppedIndex) {
                const favs = JSON.parse(localStorage.getItem("userFavorites") || "[]");
                const draggedFav = favs[draggedIndex];
                favs.splice(draggedIndex, 1);
                favs.splice(droppedIndex, 0, draggedFav);
                saveFavorites(favs);
                loadFavorites();
            }
            draggedIndex = null;
        }

        async function addFavoriteFromModal() {
            const name = document.getElementById("modalName").value.trim();
            let url = document.getElementById("modalUrl").value.trim();
            const lang = localStorage.getItem("language") || "tr";
            if (!url) {
                alert(translations[lang].invalidUrlAlert);
                return;
            }
            if (!url.startsWith("http://") && !url.startsWith("https://")) {
                url = "https://" + url;
            }
            try {
                new URL(url);
                const favs = JSON.parse(localStorage.getItem("userFavorites") || "[]");
                const maxFav = parseInt(localStorage.getItem("maxFavorites") || "5");
                if (favs.length >= maxFav) {
                    alert(translations[lang].maxFavoritesAlert);
                    return;
                }
                const finalName = name || await fetchWebsiteTitle(url);
                favs.push({ name: finalName, url });
                saveFavorites(favs);
                loadFavorites();
                document.getElementById("addFavoriteModal").style.display = "none";
                document.getElementById("modalName").value = "";
                document.getElementById("modalUrl").value = "";
            } catch {
                alert(translations[lang].invalidUrlAlert);
            }
        }

        function loadSearchHistory() {
            const lang = localStorage.getItem("language") || "tr";
            const historyList = document.getElementById("historyList");
            if (historyList) {
                historyList.innerHTML = "";
                const history = JSON.parse(localStorage.getItem("searchHistory") || "[]");
                if (history.length === 0) {
                    const noHistoryMsg = document.createElement("li");
                    noHistoryMsg.textContent = translations[lang]?.noHistory || "Geçmiş yok";
                    historyList.appendChild(noHistoryMsg);
                } else {
                    history.forEach(item => {
                        const li = document.createElement("li");
                        li.textContent = item;
                        historyList.appendChild(li);
                    });
                }
            }
        }

        document.getElementById("voiceSearchBtn").onclick = () => {
            const lang = localStorage.getItem("language") || "tr";
            if (!("webkitSpeechRecognition" in window)) {
                alert(translations[lang].voiceSearchNotSupported);
                return;
            }

            const recognition = new webkitSpeechRecognition();
            const langMap = {
                "tr": "tr-TR",
                "en": "en-US",
                "es": "es-ES",
                "ru": "ru-RU",
                "jp": "ja-JP",
                "zh": "zh-CN",
                "ko": "ko-KR",
                "de": "de-DE",
                "fr": "fr-FR",
                "ar": "ar-SA",
                "az": "az-AZ",
                "tk": "tk-TM",
                "kk": "kk-KZ",
                "ky": "ky-KG",
                "uz": "uz-UZ",
                "tt": "tt-RU",
                "ba": "ba-RU",
                "ug": "ug-CN",
                "sah": "sah-RU",
                "cv": "cv-RU",
                "gag": "gag-TR"
            };
            recognition.lang = langMap[lang] || "en-US";
            recognition.interimResults = true;
            recognition.continuous = false;
            recognition.maxAlternatives = 1;

            recognition.start();

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        document.getElementById("searchInput").value = (transcript.trim());
                        search();
                        recognition.stop();
                    } else {
                        interimTranscript += transcript;
                    }
                }
                document.getElementById("searchInput").value = interimTranscript.trim() || document.getElementById("searchInput").value;
            };

            recognition.onerror = (event) => {
                console.error("Ses tanıma hatası:", event.error);
                alert(`${translations[lang].voiceSearchNotSupported} (Hata: ${event.error})`);
                recognition.stop();
            };

            recognition.onend = () => {
                console.log("Ses tanıma sona erdi.");
            };

            setTimeout(() => {
                if (recognition && recognition.state === "recording") {
                    recognition.stop();
                    alert(translations[lang].voiceSearchNotSupported + " (Zaman aşımı)");
                }
            }, 10000);
        };

        document.getElementById("settingsButton").addEventListener("click", (e) => {
            e.stopPropagation();
            const p = document.getElementById("settingsPanel");
            p.style.display = p.style.display === "block" ? "none" : "block";
            document.getElementById("historyPanel").style.display = "none";
        });

        document.getElementById("historyButton").addEventListener("click", (e) => {
            e.stopPropagation();
            const p = document.getElementById("historyPanel");
            p.style.display = p.style.display === "block" ? "none" : "block";
            document.getElementById("settingsPanel").style.display = "none";
            loadSearchHistory();
        });

        document.getElementById("clearHistoryBtn").onclick = () => {
            localStorage.setItem("searchHistory", "[]");
            loadSearchHistory();
        };

        document.getElementById("searchEngineSelect").addEventListener("change", updateSearchEnginePreview);

        document.getElementById("addFavoriteModalBtn").addEventListener("click", addFavoriteFromModal);

        document.getElementById("applySettingsBtn").addEventListener("click", () => {
            applySettings(loadCachedBackground, updateLanguage, loadFavorites, updateSearchEnginePreview, fetchWeather, bindShortcuts, startWeatherUpdate);
            document.getElementById("settingsPanel").style.display = "none";
            document.getElementById("historyPanel").style.display = "none";
        });

        document.querySelectorAll('.color-option').forEach(option => {
            option.onclick = () => {
                const color = option.style.backgroundColor;
                const hexColor = rgbToHex(color);
                selectColor(hexColor);
            };
        });

        window.onload = () => {
            if (typeof translations === "undefined") {
                setTimeout(window.onload, 50);
                return;
            }
            fetchWeather();
            const bg = localStorage.getItem("bgUrl") || "https://images.pexels.com/photos/19161533/pexels-photo-19161533.jpeg";
            const f = localStorage.getItem("font") || "'open-sans', sans-serif";
            const t = localStorage.getItem("theme") || "dark";
            const c = localStorage.getItem("accentColor") || "#00bcd4";
            const l = localStorage.getItem("language") || "tr";
            const se = localStorage.getItem("searchEngine") || "google";
            const sf = localStorage.getItem("showFavorites") || "true";
            const ss = localStorage.getItem("showSuggestions") || "true";
            const sw = localStorage.getItem("showWeather") || "true";
            const si = localStorage.getItem("showInfoBar") || "true";
            const ld = localStorage.getItem("logoDisplay") || "logo-name";
            const maxFav = localStorage.getItem("maxFavorites") || "5";
            const searchShortcut = localStorage.getItem("searchShortcut") || "Ctrl + /";
            const favoriteShortcut = localStorage.getItem("favoriteShortcut") || "Ctrl + Shift + F";
            const settingsShortcut = localStorage.getItem("settingsShortcut") || "Ctrl + Shift + S";
            const historyShortcut = localStorage.getItem("historyShortcut") || "Ctrl + Shift + H";
            const imagesShortcut = localStorage.getItem("imagesShortcut") || "Ctrl + I";
            const shoppingShortcut = localStorage.getItem("shoppingShortcut") || "Ctrl + S";
            const newsShortcut = localStorage.getItem("newsShortcut") || "Ctrl + N";
            const weatherLocation = localStorage.getItem("weatherLocation") || "";
            const weatherUpdateInterval = localStorage.getItem("weatherUpdateInterval") || "10";
            const linkBehavior = localStorage.getItem("linkBehavior") || "newTab";

            document.getElementById("bgUrlInput").value = bg;
            document.getElementById("fontSelect").value = f;
            document.getElementById("themeSelect").value = t;
            document.getElementById("accentColor").value = c;
            document.getElementById("languageSelect").value = l;
            document.getElementById("searchEngineSelect").value = se;
            document.getElementById("showFavorites").value = sf;
            document.getElementById("showSuggestions").value = ss;
            document.getElementById("showWeather").value = sw;
            document.getElementById("showInfoBar").value = si;
            document.getElementById("logoDisplaySelect").value = ld;
            document.getElementById("maxFavorites").value = maxFav;
            document.getElementById("searchShortcutInput").value = searchShortcut;
            document.getElementById("favoriteShortcutInput").value = favoriteShortcut;
            document.getElementById("settingsShortcutInput").value = settingsShortcut;
            document.getElementById("historyShortcutInput").value = historyShortcut;
            document.getElementById("imagesShortcutInput").value = imagesShortcut;
            document.getElementById("shoppingShortcutInput").value = shoppingShortcut;
            document.getElementById("newsShortcutInput").value = newsShortcut;
            document.getElementById("weatherLocation").value = weatherLocation;
            document.getElementById("weatherUpdateInterval").value = weatherUpdateInterval;
            document.getElementById("linkBehavior").value = linkBehavior;

            applySettings(loadCachedBackground, updateLanguage, loadFavorites, updateSearchEnginePreview, fetchWeather, bindShortcuts, startWeatherUpdate);

            const searchInput = document.getElementById("searchInput");
            const suggestionsBox = document.getElementById("suggestions");
            let selectedIndex = -1;

            function fetchSuggestions(query) {
                if (localStorage.getItem("showSuggestions") === "false") return;
                const encodedQuery = encodeURIComponent(query.trim());
                const callbackName = "jsonpCallback_" + Math.random().toString(36).substr(2);
                window[callbackName] = function(data) {
                    try {
                        console.log("Google Suggest JSONP yanıtı:", data);
                        const suggestionsBox = document.getElementById("suggestions");
                        suggestionsBox.innerHTML = "";
                        const suggestions = data[1].slice(0, 8);
                        suggestionsBox.style.display = suggestions.length ? "block" : "none";
                        suggestions.forEach(suggestion => {
                            const li = document.createElement("li");
                            li.textContent = suggestion;
                            li.onclick = () => {
                                document.getElementById("searchInput").value = suggestion;
                                search();
                                suggestionsBox.style.display = "none";
                            };
                            suggestionsBox.appendChild(li);
                        });
                        selectedIndex = -1;
                    } catch (e) {
                        console.error("Öneri alınamadı:", e);
                        const suggestionsBox = document.getElementById("suggestions");
                        suggestionsBox.innerHTML = `<li style="padding: 12px; color: #ff4444;">${translations[localStorage.getItem("language") || "tr"].noSuggestions}</li>`;
                        suggestionsBox.style.display = "block";
                    } finally {
                        delete window[callbackName];
                    }
                };
                const script = document.createElement("script");
                script.src = `https://suggestqueries.google.com/complete/search?client=firefox&q=${encodedQuery}&jsonp=${callbackName}`;
                script.onload = () => {
                    script.remove();
                };
                script.onerror = () => {
                    console.error("Öneri alınamadı: Script yüklenemedi");
                    const suggestionsBox = document.getElementById("suggestions");
                    suggestionsBox.innerHTML = `<li style="padding: 12px; color: #ff4444;">${translations[localStorage.getItem("language") || "tr"].noSuggestions}</li>`;
                    suggestionsBox.style.display = "block";
                    delete window[callbackName];
                    script.remove();
                };
                document.body.appendChild(script);
            }

            const debouncedFetchSuggestions = debounce(fetchSuggestions, 200);

            searchInput.addEventListener("input", () => {
                const query = searchInput.value.trim();
                if (query) {
                    debouncedFetchSuggestions(query);
                } else {
                    suggestionsBox.style.display = "none";
                }
            });

            searchInput.addEventListener("keydown", (e) => {
                const suggestions = suggestionsBox.querySelectorAll("li");
                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    if (selectedIndex < suggestions.length - 1) {
                        selectedIndex++;
                        suggestions.forEach((li, i) => {
                            li.classList.toggle("selected", i === selectedIndex);
                        });
                        suggestionsBox.scrollTop = suggestions[selectedIndex]?.offsetTop - suggestionsBox.offsetHeight / 2;
                    }
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    if (selectedIndex > -1) {
                        selectedIndex--;
                        suggestions.forEach((li, i) => {
                            li.classList.toggle("selected", i === selectedIndex);
                        });
                        suggestionsBox.scrollTop = suggestions[selectedIndex]?.offsetTop - suggestionsBox.offsetHeight / 2;
                    }
                } else if (e.key === "Enter") {
                    e.preventDefault();
                    if (selectedIndex > -1 && suggestions[selectedIndex]) {
                        searchInput.value = suggestions[selectedIndex].textContent;
                        suggestionsBox.style.display = "none";
                        search();
                    } else if (searchInput.value.trim()) {
                        search();
                    }
                } else if (e.key === "Escape") {
                    suggestionsBox.style.display = "none";
                }
            });

            document.addEventListener("click", (e) => {
                if (!e.target.closest("#settingsPanel") && !e.target.closest("#settingsButton")) {
                    document.getElementById("settingsPanel").style.display = "none";
                }
                if (!e.target.closest("#historyPanel") && !e.target.closest("#historyButton")) {
                    document.getElementById("historyPanel").style.display = "none";
                }
                if (!e.target.closest("#searchBar") && !e.target.closest("#suggestions")) {
                    suggestionsBox.style.display = "none";
                }
                if (!e.target.closest("#addFavoriteModal") && !e.target.closest("#addFavoriteBtn")) {
                    document.getElementById("addFavoriteModal").style.display = "none";
                }
            });
        };
    </script>
</body>
</html>
